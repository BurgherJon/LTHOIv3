<!DOCTYPE html>
<html>
<head>
    <title>LTHOI Shitty UI</title>

    <!-- Firebase Stuff -->
    <script src="https://www.gstatic.com/firebasejs/4.1.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.2/firebase-messaging.js"></script>
    <!-- End Firebase Stuff -->

<!-- Firebase Stuff -->
<script src="https://www.gstatic.com/firebasejs/4.1.2/firebase.js"></script>
<script>
  // Initialize Firebase, Obviously should be hidden in the real app.
  var config = {
    apiKey: "AIzaSyBfZ67kQFlBE8XiOcbPuCuGT0p2OQjxXTs",
    authDomain: "lthoi-test.firebaseapp.com",
    databaseURL: "https://lthoi-test.firebaseio.com",
    projectId: "lthoi-test",
    storageBucket: "lthoi-test.appspot.com",
    messagingSenderId: "424262593373"
  };
  firebase.initializeApp(config);
</script>

</head>


<body role="document" style="padding-top: 70px;">
    <table width="100%">
        <tr>
            <th width="70%">
                <br>Welcome to Leave The House Out of It Shitty Dev UI!<br>
            </th>
            <th>
                <div id='userinfo'></div>
            </th>
        </tr>
        <tr>
            <th>
                <div id="maindisplay" align="left"></div>
            </th>
            <th>
                <div id="sidebar"></div>
            </th>
        </tr>

    </table>
</body>


<script type="text/javascript">
    /*************************************************************************************/
    /********** Global Variables**********************************************************/
    /*************************************************************************************/
    var lsid = 0; //The League season that is currently logged in.
    var week = "error";  //The short-name of the week that is being looked at.
    var fid = "error";  //The firebase id of the current user.



    /*************************************************************************************/
    /*********   This is called initially to setup the connection with the API   *********/
    /*************************************************************************************/
    function init() {
      //This is standard Google stuff to load the API.
      var apiName = 'playerapi';
      var apiVersion = 'v1';
      var apiRoot = 'https://' + window.location.host + '/_ah/api';
      gapi.client.setApiKey("AIzaSyDT-hXFhfRcHvmiFqEzTxaLQh2u0FY62Gc");  //Set the id Token.  This should obviously, be hidden in the actual application.
      if (window.location.hostname == 'localhost' || window.location.hostname == '127.0.0.1')
      {
            // We're probably running against the DevAppServer so don't use https...
            apiRoot = 'http://' + window.location.host + '/_ah/api';
      }

      var callback = function()
      {
           setupUser();
      }
      gapi.client.load(apiName, apiVersion, callback, apiRoot);
    }

    /************************************************************************************/
    /**************  Setup User and Load the Leagues They Are In  ***********************/
    /************************************************************************************/
    function setupUser() {
         fid = firebase.auth().currentUser.uid;
         var requestData = {};
         requestData.firebase_uid = fid;

         gapi.client.playerapi.getMe(requestData).execute
         (
          function(response)
          {
            if (!response.error)
            {
              //Put the username in the corner.
              userinfo.innerHTML = "Hello " + response.fname;

              //Setup League Options
              var display = 'Choose the league you want to work with:<br>';
              display = display + '<Table width="100%" border="1">';

              var leagues = response.leagues || [];

              if (leagues.length > 0)
              {
                  display = display + "<tr><th>Name</th><th>Wins</th><th>Losses</th><th>Pushes</th><th>Winnings</th></tr>";
                  for (z=0;z<leagues.length;z++)
                  {
                      display = display + "<tr><th>";

                      //setup the button for that league
                      display = display + "<button onclick='displayWeek(" + leagues[z].league_Season_ID + ", \"" + response.wshort + "\")'>" + leagues[z].league_Name + "</button>"

                      display = display + "</th><th>" + leagues[z].wins + "</th><th>" + leagues[z].losses + "</th><th>" + leagues[z].pushes + "</th><th>" + leagues[z].winnings + "</th></tr>";
                  }
              }
              else
              {
                  display = display + '<tr><th>You haven\'t joined any leagues.  Please contact a league administrator.</tr></th>';
              }
              display = display + '</Table>';
              maindisplay.innerHTML = display;
            }
            else if (response.error)
            {
              //The most common error will be that someone came to the page accidentally and doesn't have an account setup (or is using a new ID).  This is returned as a 503 with the message "Firebase UID not recognized."
              if (response.error.code == 503) //If it came back undefined they'll have to call to get setup.
              {
                maindisplay.innerHTML = 'We do not recognize you with that login.  This could be for several reasons.<br>1.  You have never used that particular method to authenticate (e.g. you used to use Facebook and just used Twitter).  You can either <a href="index.html">GO BACK</a> and use the old way or email your league administrator to add this new authentication.<br>2. You\'re a new user.  Welcome!  Please email your league administrator and tell him who you are so that he can link this login method to your id.<br>3. The system isn\'t behaving properly... shame on Jonathan.';
              }


              userinfo.innerHTML = '<b>Error Code: </b>' + response.error.code + ' [' + response.error.message + ']';
            }
          }
        );

        return false;
    }


    /***************************************************************************************************/
    /******************** Show a Week of Potential Bets ************************************************/
    /***************************************************************************************************/

    function displayWeek(intinput, strinput)
    {
        lsid = intinput;
        week = strinput;

        maindisplay.innerHTML = lsid + " " + week + " " + fid;

        var requestData = {};
        requestData.firebase_uid = fid;
        requestData.week = week;
        requestData.league_season_id = lsid;

        gapi.client.playerapi.getWeek(requestData).execute
        (
         function(response)
         {
           if (!response.error)
           {
             //Display the week.
             var display = "<h1 align='center'>" + response.long_Name + "</h1>";

             //Display buttons for next or previous week.
             //display += "<button onclick='displayWeek(" + leagues[z].league_Season_ID + ", \"" + response.wshort + "\")'>" + "Previous Week" + "</button>"
             //display += "<button onclick='displayWeek(" + leagues[z].league_Season_ID + ", \"" + response.wshort + "\")'>" + "Next Week" + "</button>"

             //Add table structure
             display += '<Table width="100%" border="1">';
             display += "<tr><th width='10%'></th><th width='25%'>Home Team</th><th width='7%'>Score</th><th width='16%'>Bet and Line</th><th width='7%'>Score</th><th width='25%'>Away Team</th><th width='10%'></th></tr>";

             //Loop through the games
             var games = response.games || [];
             for (z=0;z<games.length;z++)
             {
                  display += "<tr>";

                  //Bet button on home team.
                  display += "<th>";
                  display += "<button onclick='placeBet(\"" + games[z].home_team + "\")'>+</button>";
                  display += "<button onclick='deleteBet(\"" + games[z].home_team + "\")'>-</button>";
                  display += "</th>";

                  //Display Game Data
                  display += "<th>" + games[z].home_team + "</th>";
                  display += "<th>" + games[z].home_score + "</th>";
                  display += "<th>$" + parseFloat(Math.round(games[z].user_net_home_bet * 100) / 100).toFixed(2) + " at " + games[z].home_line + "</th>";
                  display += "<th>" + games[z].away_score + "</th>";
                  display += "<th>" + games[z].away_team + "</th>";

                  //Bet button on away team.
                  display += "<th>";
                  display += "<button onclick='placeBet(\"" + games[z].away_team + "\")'>+</button>";
                  display += "<button onclick='deleteBet(\"" + games[z].away_team + "\")'>-</button>";
                  display += "</th>";

                  display += "</tr>"
             }

             maindisplay.innerHTML = display;
           }
           else if (response.error)
           {
             maindisplay.innerHTML = '<b>Error Code: </b>' + response.error.code + ' [' + response.error.message + ']';
           }
         }
       );


    }


    /***************************************************************************************************/
    /******************** Place a Bet, Reload Screen ***************************************************/
    /***************************************************************************************************/

    function placeBet(strTeam)
    {
        var requestData = {};
        requestData.team_name = strTeam;
        requestData.firebase_uid = fid;
        requestData.week = week;
        requestData.league_season_id = lsid;

        gapi.client.playerapi.setBet(requestData).execute
        (
         function(response)
         {
           if (!response.error)
           {
             displayWeek(lsid, week);
           }
           else if (response.error)
           {
             maindisplay.innerHTML = '<b>Error Code: </b>' + response.error.code + ' [' + response.error.message + ']';
           }
         }
       );


    }



    /***************************************************************************************************/
    /******************** Remove a Bet, Reload Screen *********   ************************************************/
    /***************************************************************************************************/

    function deleteBet(strTeam)
    {
        var requestData = {};
        requestData.team_name = strTeam;
        requestData.firebase_uid = fid;
        requestData.week = week;
        requestData.league_season_id = lsid;

        gapi.client.playerapi.deleteBet(requestData).execute
        (
         function(response)
         {
           if (!response.error)
           {
             displayWeek(lsid, week);
           }
           else if (response.error)
           {
             maindisplay.innerHTML = '<b>Error Code: </b>' + response.error.code + ' [' + response.error.message + ']';
           }
         }
       );


    }


</script>



<!--
 Load the Google APIs Client Library for JavaScript
 More info here : https://developers.google.com/api-client-library/javascript/reference/referencedocs
-->

<script src="https://apis.google.com/js/client.js?onload=init"></script>
</html>
